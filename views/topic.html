{{ block "topic" . }}
<!DOCTYPE html>
<html lang="en">
        <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>forumv2</title>
                <script src="https://unpkg.com/htmx.org@2.0.4" 
                        integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" 
                        crossorigin="anonymous">
                </script>
                <link rel="stylesheet" href="/css/topic.css">
                <link rel="stylesheet" href="/css/main.css">
                <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
        </head>
        <body>
                {{ template "navbar" . }}
                {{ template "topic-subject" .Subject }}
                {{ template "topic-message" . }}
                {{ template "topic-form" . }}

                <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
                <script>
                        const quill = new Quill('#editor', {
                                modules: {
                                        toolbar: [
                                                [{ header: [1, 2, false] }],
                                                ["bold", "italic", "underline"],
                                                ["blockquote", "code-block"],
                                                ["link"],
                                                ["image"],
                                        ],
                                },
                                placeholder: "Send a message",
                                theme: "snow"
                        });

                        document.getElementById("topic-form").addEventListener("submit", function(event) {
                                let quillContent = quill.root.innerHTML;
                                document.getElementById("quill-content").value = quillContent;
                        });
                </script>

                <script>
                        document.addEventListener("DOMContentLoaded", (event) => {
                                document.body.addEventListener("htmx:beforeSwap", function(evt) {
                                        if (evt.detail.xhr.status === 422 || evt.detail.xhr.status === 500) {
                                                evt.detail.shouldSwap = true;
                                                evt.detail.isError = false;
                                        }
                                });
                        });
                </script>
        </body>
</html>
{{ end }}

{{ block "topic-form" . }}
        <form 
                hx-post="/message"
                hx-vals='{"uuid": "{{ .Subject.UUID }}"}'
                id="topic-form"
        >
                {{ if .User.UUID }}
                        <div id="editor"></div>
                        <input type="hidden" name="message" id="quill-content">
                        <button type="submit">add</button>
                {{ else }}
                        <p>Login to post a message</p>
                {{ end }}

                {{ template "status" .Status }}
        </form>
{{ end }}

{{ block "topic-subject" .Subject }}
        <div class="message">
                <a href="/user/{{ .CreatedByUsername }}">{{ .CreatedByUsername }}</a>- {{ .FormattedLastMessage }}
                <p class="title">{{ .Name }}</p>
                {{ .Description }}
        </div>
{{ end }}

{{ block "topic-message" . }}
        <div id="message-display">
                {{ template "message-display" . }}
        </div>
{{ end }}

{{ block "message-display" . }}
        {{ $userUUID := .User.UUID }}

        {{ range .Messages }}
                <div id="message{{ .UUID }}" class="message">
                        <a href="/user/{{ .CreatedByUsername }}">{{ .CreatedByUsername }}</a> - {{ .FormattedCreationTime }}
                        <div class="content">{{ .Content | safeHTML }}</div>
                        {{ if eq $userUUID .CreatedByUUID }}
                                <button
                                        hx-delete="/message"
                                        hx-vals='{"uuid": "{{ .UUID }}", "createdBy": "{{ .CreatedByUUID }}"}'
                                        hx-swap="outerHTML"
                                        hx-target="#message{{ .UUID }}"
                                > Delete </button>
                        {{ end }}
                        <br/>
                </div>
        {{ end }}
{{ end }}

{{ block "oob-message" . }}
        <div id="message-display" hx-swap-oob="afterbegin">
                {{ template "message-display" . }}
        </div>
{{ end }}
